DROP SCHEMA public CASCADE;
CREATE SCHEMA public;

/* Tipos */
CREATE TYPE TIPO_CARRERA AS ENUM('EVENTO', 'CIRCUITO');
CREATE TYPE TIPO_CONTROL AS ENUM('SALIDA', 'CONTROL', 'META');
CREATE TYPE MODALIDAD AS ENUM('TRAZADO', 'SCORE');

/* Cast para inserción de controles */
CREATE CAST (CHARACTER VARYING AS TIPO_CONTROL) WITH INOUT AS IMPLICIT;
/* Cast para JSON */
CREATE CAST (CHARACTER VARYING AS JSON) WITH INOUT AS IMPLICIT;

/* Tablas */
CREATE TABLE IF NOT EXISTS USUARIOS (
	ID SERIAL,
	NOMBRE VARCHAR(30) NOT NULL UNIQUE,
	EMAIL VARCHAR(100) NOT NULL UNIQUE,
	CLUB VARCHAR(30),
	PASSWORD VARCHAR(64) NOT NULL,
	FECHA_REGISTRO DATE NOT NULL,
	PRIMARY KEY (ID)
);

CREATE TABLE IF NOT EXISTS CARRERAS (
	ID SERIAL,
	SECRET TEXT NOT NULL,
	NOMBRE VARCHAR(50) NOT NULL,
	TIPO TIPO_CARRERA NOT NULL,
	MODALIDAD MODALIDAD NOT NULL,
	ORGANIZADOR_ID INTEGER REFERENCES USUARIOS(ID),
	PRIVADA BOOLEAN NOT NULL DEFAULT FALSE,
	LATITUD REAL,
	LONGITUD REAL,
	NOTAS VARCHAR(1000),
	FECHA DATE DEFAULT CURRENT_DATE,
	CONTROLES JSON NOT NULL,
	PRIMARY KEY (ID)
);

CREATE TABLE IF NOT EXISTS RECORRIDOS (
	ID SERIAL,
	NOMBRE TEXT NOT NULL,
	CARRERA_ID INTEGER REFERENCES CARRERAS(ID) ON DELETE CASCADE,
	TRAZADO JSON NOT NULL,
	MAPA BYTEA,
	PRIMARY KEY (ID)
);


CREATE TABLE IF NOT EXISTS PARTICIPACIONES (
	ID SERIAL,
	CORREDOR_ID INTEGER NOT NULL REFERENCES USUARIOS(ID) ON DELETE CASCADE,
	RECORRIDO_ID INTEGER NOT NULL REFERENCES RECORRIDOS(ID) ON DELETE CASCADE,
	FECHA_INICIO TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	REGISTROS JSON NOT NULL,
	ABANDONADO BOOLEAN NOT NULL DEFAULT FALSE,
	PENDIENTE BOOLEAN NOT NULL DEFAULT TRUE,
	PRIMARY KEY(ID)
);


/**** DATOS DE PRUEBA ****/
ALTER SEQUENCE usuarios_id_seq restart with 5;   -- Debido a las inserciones de prueba
ALTER SEQUENCE carreras_id_seq restart with 3;   -- Debido a las inserciones de prueba
ALTER SEQUENCE controles_id_seq restart with 15; -- Debido a las inserciones de prueba
INSERT INTO USUARIOS(ID, NOMBRE, EMAIL, CLUB, PASSWORD, FECHA_REGISTRO) VALUES (1, 'Cuenta borrada', '', '', '<redacted>', '2020-03-15');
INSERT INTO USUARIOS(ID, NOMBRE, EMAIL, CLUB, PASSWORD, FECHA_REGISTRO) VALUES (2, 'Pepito Pérez', 'pepito@test.com', 'ORCA', '<redacted>', '2020-06-18');
INSERT INTO USUARIOS(ID, NOMBRE, EMAIL, CLUB, PASSWORD, FECHA_REGISTRO) VALUES (3, 'Fernandito Fernández', 'fernandito@test.com', 'TJALVE', '<redacted>', '2020-07-06');
INSERT INTO USUARIOS(ID, NOMBRE, EMAIL, CLUB, PASSWORD, FECHA_REGISTRO) VALUES (4, 'Juanito Juárez', 'juanito@test.com', '', '<redacted>', '2020-06-20');

INSERT INTO CARRERAS(ID, SECRET, NOMBRE, TIPO, MODALIDAD, ORGANIZADOR_ID, LATITUD, LONGITUD, PRIVADA, NOTAS, CONTROLES) VALUES (1, 'not-a-real-secret', 'Prueba de carrera', 'EVENTO', 'TRAZADO', 1, 42.5221944, -4.7366028, FALSE, 'La salida de la carrera estará en el centro del parque en una mesa.\nPara cualquier duda contactar con usuario@dominio.com.', '{"31":{"codigo":"31","tipo":"CONTROL","puntuacion":0,"coords":null},"32":{"codigo":"32","tipo":"CONTROL","puntuacion":0,"coords":null},"33":{"codigo":"33","tipo":"CONTROL","puntuacion":0,"coords":null},"SALIDA":{"codigo":"SALIDA","tipo":"SALIDA","puntuacion":0,"coords":null},"META":{"codigo":"META","tipo":"META","puntuacion":0,"coords":null}}');
INSERT INTO CARRERAS(ID, SECRET, NOMBRE, TIPO, MODALIDAD, ORGANIZADOR_ID, PRIVADA, CONTROLES) VALUES (2, 'not-a-real-secret', 'Otra carrera', 'EVENTO', 'SCORE', 3, TRUE, '{"31":{"codigo":"31","tipo":"CONTROL","puntuacion":0,"coords":null},"32":{"codigo":"32","tipo":"CONTROL","puntuacion":0,"coords":null},"33":{"codigo":"33","tipo":"CONTROL","puntuacion":0,"coords":null},"SALIDA":{"codigo":"SALIDA","tipo":"SALIDA","puntuacion":0,"coords":null},"META":{"codigo":"META","tipo":"META","puntuacion":0,"coords":null}}');

/* Recorridos Carrera 1 (TRAZADO) */
INSERT INTO RECORRIDOS(NOMBRE, CARRERA_ID, TRAZADO, MAPA) VALUES ('OPEN AMARILLO', 1, '["SALIDA", "31", "32", "META"]', NULL);
INSERT INTO RECORRIDOS(NOMBRE, CARRERA_ID, TRAZADO, MAPA) VALUES ('OPEN NARANJA', 1, '["SALIDA", "31", "33", "32", "META"]', NULL);
INSERT INTO RECORRIDOS(NOMBRE, CARRERA_ID, TRAZADO, MAPA) VALUES ('OPEN ROJO', 1, '["SALIDA", "31", "32", "33", "META"]', NULL);
/* Recorridos Carrera 2 (SCORE) */
INSERT INTO RECORRIDOS(NOMBRE, CARRERA_ID, TRAZADO, MAPA) VALUES ('ASDF', 2, '["SALIDA", "META"]', NULL);


/*
[
	{
		"control": "SALIDA",
		"fecha": "2020-06-30 09:13:39"
	},
	{
		"control": "31",
		"fecha": "2020-06-30 09:15:03"
	},
	{
		"control": "32",
		"fecha": "2020-06-30 09:16:03"
	},
	{
		"control": "META",
		"fecha": "2020-06-30 09:17:03"
	}
]
*/
/*Open amarillo */
INSERT INTO PARTICIPACIONES(CORREDOR_ID, RECORRIDO_ID, REGISTROS, ABANDONADO, PENDIENTE) VALUES (2, 1, '[{"control":"SALIDA","fecha":"2020-06-30 09:13:39"},{"control":"31","fecha":"2020-06-30 09:15:03"},{"control":"32","fecha":"2020-06-30 09:16:03"},{"control":"META","fecha":"2020-06-30 09:17:03"}]', FALSE, FALSE);
INSERT INTO PARTICIPACIONES(CORREDOR_ID, RECORRIDO_ID, REGISTROS, ABANDONADO, PENDIENTE) VALUES (3, 1, '[{"control":"SALIDA","fecha":"2020-06-30 09:14:23"},{"control":"31","fecha":"2020-06-30 09:18:03"},{"control":"32","fecha":"2020-06-30 09:21:40"},{"control":"META","fecha":"2020-06-30 09:17:03"}]', FALSE, FALSE);
INSERT INTO PARTICIPACIONES(CORREDOR_ID, RECORRIDO_ID, REGISTROS, ABANDONADO, PENDIENTE) VALUES (4, 1, '[{"control":"SALIDA","fecha":"2020-06-30 09:11:45"},{"control":"31","fecha":"2020-06-30 09:19:03"},{"control":"32","fecha":"2020-06-30 09:20:32"}]', TRUE, FALSE);
/* Open naranja */
INSERT INTO PARTICIPACIONES(CORREDOR_ID, RECORRIDO_ID, REGISTROS, ABANDONADO, PENDIENTE) VALUES (2, 2, '[{"control":"SALIDA","fecha":"2020-06-30 09:13:39"},{"control":"31","fecha":"2020-06-30 09:15:03"},{"control":"33","fecha":"2020-06-30 09:16:03"}]', FALSE, TRUE);
INSERT INTO PARTICIPACIONES(CORREDOR_ID, RECORRIDO_ID, REGISTROS, ABANDONADO, PENDIENTE) VALUES (3, 2, '[{"control":"SALIDA","fecha":"2020-06-30 09:13:39"},{"control":"31","fecha":"2020-06-30 09:15:03"}]', TRUE, TRUE);
--INSERT INTO PARTICIPACIONES(CORREDOR_ID, RECORRIDO_ID, REGISTROS, ABANDONADO, PENDIENTE) VALUES (4, 2, '[{"control":"SALIDA","fecha":"2020-06-30 09:13:39"},{"control":"31","fecha":"2020-06-30 09:15:03"},{"control":"33","fecha":"2020-06-30 09:16:03"}]', FALSE, TRUE);
